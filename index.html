<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>GPT — A New Note-Taking App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* --- Neptune Theme --- */
    :root {
      --bg-primary: #1a1c2c;
      --bg-secondary: #24273a;
      --panel-bg: #1e2030;
      --text-primary: #cad3f5;
      --text-secondary: #a5adce;
      --text-muted: #6e789f;
      --accent-primary: #8caaee;
      --accent-secondary: #babbf1;
      --border-color: #363a4f;
      --danger-color: #e78284;
      --success-color: #a6d189;
      --warning-color: #e5c890;
      --shadow-light: 0 4px 15px rgba(0,0,0,.1);
      --shadow-dark: 0 6px 25px rgba(0,0,0,.3);
    }
    
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Segoe UI', 'Roboto', system-ui, -apple-system, sans-serif;
      font-size: 15px;
      line-height: 1.6;
    }
    
    #app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      opacity: 0;
      transition: opacity 0.4s ease-in;
    }

    #app-container.loaded {
      opacity: 1;
    }

    .main-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 10px 20px;
      background: var(--panel-bg);
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-dark);
      position: sticky; top: 0; z-index: 100;
    }
    .brand-title {
      font-weight: 600;
      font-size: 18px;
      color: var(--accent-secondary);
      user-select: none;
      text-decoration: none;
    }
    .search-box {
      flex: 1;
      position: relative;
    }
    .search-box input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      outline: none;
      transition: all .2s ease;
    }
    .search-box input:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(140, 170, 238, .2);
    }
    
    .header-actions { display: flex; gap: 10px; }
    
    .btn {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all .2s ease;
    }
    .btn:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      transform: translateY(-1px);
    }
    .btn.primary {
      background: var(--accent-primary);
      color: #1a1c2c;
      border-color: var(--accent-primary);
    }
    .btn.primary:hover {
        background: var(--accent-secondary);
        border-color: var(--accent-secondary);
    }
    .btn.danger {
      color: var(--danger-color);
      border-color: var(--danger-color);
    }
    .btn.danger:hover {
      background: rgba(231, 130, 132, 0.1);
      color: #fff;
    }

    .data-container {
      display: grid;
      grid-template-columns: 280px 300px 1fr;
      flex: 1;
      min-height: 0;
    }

    .panel {
      background: var(--panel-bg);
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 12px 15px;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .05em;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      background: var(--panel-bg);
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .grow { flex: 1; }
    
    .tree-list { padding: 10px; display: flex; flex-direction: column; gap: 5px; }
    .tree-item, .page-entry {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all .2s ease;
      border: 1px solid transparent;
      position: relative;
    }
    .tree-item:hover, .page-entry:hover { background: var(--bg-secondary); }
    .tree-item.active {
        box-shadow: inset 0 0 0 2px var(--accent-primary);
    }
    .page-entry.active {
        background-color: var(--bg-secondary);
        color: var(--accent-secondary);
    }

    .action-btn {
        visibility: hidden;
        opacity: 0;
        transition: opacity .2s ease;
        background: none; border: none; cursor: pointer;
        padding: 4px; line-height: 1;
        color: var(--text-secondary);
    }
    .tree-item:hover .action-btn, .page-entry:hover .action-btn, #page-title-container:hover .action-btn {
        visibility: visible;
        opacity: 1;
    }
    .action-btn:hover { color: var(--accent-primary); }
    .delete-btn:hover { color: var(--danger-color); }

    .actions-container {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 4px;
        background: var(--bg-secondary);
        border-radius: 6px;
    }

    .title-input {
      background: transparent;
      border: none;
      color: inherit;
      font-weight: 500;
      padding: 4px 6px;
      border-radius: 6px;
      width: 100%;
      margin: -4px -6px;
    }
    .title-input:focus {
      outline: none;
      background: var(--bg-primary);
      box-shadow: 0 0 0 2px var(--accent-primary);
    }
    .title-input[readonly] { cursor: pointer; user-select: none;}
    .title-input[readonly]:focus { background: transparent; box-shadow: none; }

    .view-container {
      background: var(--bg-primary);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .view-tabs {
      display: flex;
      gap: 4px;
      padding: 8px 15px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      position: relative;
      bottom: -1px;
    }
    .tab-btn.active {
      background: var(--bg-secondary);
      color: var(--accent-primary);
      border: 1px solid var(--border-color);
      border-bottom: 1px solid var(--bg-secondary);
    }

    .view {
      padding: 20px;
      display: none;
      background: var(--bg-secondary);
      flex: 1;
    }
    .view.active {
      display: block;
    }
    .view-content {
        max-width: 900px;
        margin: 0 auto;
    }

    #page-title-container {
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
    }
    #page-title-input {
      font-size: 32px; font-weight: 700; border: none; outline: none;
      background: transparent; color: var(--text-primary); width: 100%;
      padding-bottom: 15px; margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    #page-title-input:not([readonly]) { cursor: text; }
    
    #editor-area {
      min-height: 60vh;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      line-height: 1.7;
      outline: none;
      box-shadow: inset 0 2px 10px rgba(0,0,0,.2);
    }
    #editor-area:focus { border-color: var(--accent-primary); }
    #editor-area img { max-width: 100%; border-radius: 8px; }
    
    .card {
      background: var(--panel-bg); border: 1px solid var(--border-color);
      border-radius: 10px; padding: 15px;
      display: flex; flex-direction: column; gap: 10px;
    }
    
    .color-dot {
      width: 16px; height: 16px; border-radius: 50%;
      border: 1px solid var(--border-color); cursor: pointer;
      transition: transform 0.2s ease; flex-shrink: 0;
    }
    .color-dot:hover { transform: scale(1.2); }
    
    #color-palette {
      display: none; position: absolute; background: var(--bg-secondary);
      border: 1px solid var(--border-color); border-radius: 10px;
      padding: 10px; box-shadow: var(--shadow-dark); z-index: 200;
      grid-template-columns: repeat(5, 1fr); gap: 8px; width: 160px;
    }
    .palette-swatch {
      width: 22px; height: 22px; border-radius: 50%;
      border: 1px solid var(--border-color); cursor: pointer;
      transition: transform .15s ease;
    }
    .palette-swatch:hover { transform: scale(1.15); border-color: var(--text-primary); }
    
    .hidden { display: none !important; }

    #loader {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      border: 4px solid var(--border-color); border-top: 4px solid var(--accent-primary);
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loader"></div>

<div id="app-container">
  <header class="main-header">
    <a id="brandLink" class="brand-title" href="#">GPT</a>
    <div class="search-box">
      <input id="globalSearchInput" placeholder="Cerca ovunque..." />
    </div>
    <div class="header-actions">
      <button id="addNotebookBtn" class="btn primary">+ Nuovo Taccuino</button>
      <button id="exportDataBtn" class="btn">Esporta</button>
      <label class="btn" for="importDataInput">Importa</label>
      <input id="importDataInput" type="file" accept="application/json" class="hidden" />
    </div>
  </header>

  <div class="data-container">
    <aside class="panel">
      <div id="notebooks-list" class="tree-list"></div>
    </aside>

    <aside class="panel">
      <div class="panel-header">
        <span id="pages-list-header">Pagine</span>
        <span class="grow"></span>
        <button id="addSectionBtn" class="btn">+ Sezione</button>
        <button id="addPageBtn" class="btn">+ Pagina</button>
      </div>
      <div id="pages-list" class="tree-list"></div>
    </aside>

    <main class="view-container">
      <div class="view-tabs">
        <button class="tab-btn active" data-view="editor-view">Editor</button>
        <button class="tab-btn" data-view="canvas-view">Canvas</button>
        <button class="tab-btn" data-view="attachments-view">Allegati</button>
        <button class="tab-btn" data-view="info-view">Info</button>
      </div>

      <div id="editor-view" class="view active">
        <div class="view-content hidden">
          <div id="page-title-container">
            <input id="page-title-input" placeholder="Il mio nuovo capolavoro..." readonly />
          </div>
          <div id="editor-area" contenteditable="true"></div>
        </div>
      </div>

      <div id="canvas-view" class="view">
        <p>Canvas e altre viste sono state omesse per brevità, ma il loro HTML è qui.</p>
      </div>
      <div id="attachments-view" class="view"></div>
      <div id="info-view" class="view">
        <div class="view-content">
          <h3>Informazioni Pagina</h3><div id="page-metadata" class="card"></div>
           <h3 style="margin-top: 30px;">Azioni</h3>
           <div style="display: flex; gap: 10px;"><button id="duplicatePageBtn" class="btn">Duplica</button><button id="deletePageBtn" class="btn danger">Elimina Pagina</button></div>
        </div>
      </div>
    </main>
  </div>
  
  <div id="color-palette"></div>
</div>

<script>
/* -------------------- REPO-AWARE BASE PATH -------------------- */
const REPO_SEGMENT = (location.pathname.split('/').filter(Boolean)[0] || '');
const BASE_PATH = REPO_SEGMENT ? `/${REPO_SEGMENT}/` : '/';

(function ensureBaseTag() {
  const existing = document.querySelector('head base');
  if (existing) { existing.setAttribute('href', BASE_PATH); } 
  else { const base = document.createElement('base'); base.setAttribute('href', BASE_PATH); document.head.prepend(base); }
})();

document.addEventListener('DOMContentLoaded', () => {
  const brand = document.getElementById('brandLink');
  if (brand) brand.setAttribute('href', BASE_PATH);
});

/* -------------------- UTILITIES -------------------- */
const getEl = sel => document.querySelector(sel);
const createId = (prefix = 'id') => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
function getContrastColor(hex) {
  if (!hex) return 'var(--text-primary)';
  const r = parseInt(hex.substr(1, 2), 16), g = parseInt(hex.substr(3, 2), 16), b = parseInt(hex.substr(5, 2), 16);
  const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
  return (yiq >= 150) ? '#1a1c2c' : '#ffffff';
}
function makeEditable(inputEl, saveCallback) {
    const originalValue = inputEl.value;
    inputEl.readOnly = false;
    inputEl.select();
    const finishEditing = (shouldSave = true) => {
        inputEl.readOnly = true;
        if (shouldSave && inputEl.value.trim()) { saveCallback(inputEl.value.trim()); } 
        else { inputEl.value = originalValue; }
        inputEl.removeEventListener('blur', onBlur);
        inputEl.removeEventListener('keyup', onKeyup);
    };
    const onBlur = () => finishEditing(true);
    const onKeyup = (e) => {
        if (e.key === 'Enter') finishEditing(true);
        if (e.key === 'Escape') finishEditing(false);
    };
    inputEl.addEventListener('blur', onBlur);
    inputEl.addEventListener('keyup', onKeyup);
}

/* -------------------- CORE STATE & DB -------------------- */
const DB_KEY = `gpt_notes_v8_${REPO_SEGMENT || 'root'}`;
let Store = {};
let AppState = { activeNotebookId: null, activeSectionId: null, activePageId: null };

const COLOR_PALETTE = ['#e78284','#ea999c','#e5c890','#f0daab','#a6d189','#bde0a8','#8caaee','#a3b8ef','#babbf1','#c8c9f4'];
const FONT_LIST = ['Segoe UI', 'Arial', 'Verdana', 'Georgia', 'Times New Roman', 'Courier New'];
const defaultStore = { notebooks: {}, sections: {}, pages: {}, notebookOrder: []};

function loadStore() {
  try {
    const raw = localStorage.getItem(DB_KEY);
    if (raw) { Store = JSON.parse(raw); }
    else {
      Store = JSON.parse(JSON.stringify(defaultStore));
      const notebook = createNotebook('Il mio primo Taccuino', false);
      const section = createSection(notebook.id, 'Appunti veloci', false);
      const page = createPage(section.id, 'Benvenuto!', false);
      page.html = `<h1>Ciao e benvenuto!</h1><p>Clicca sulla matita ✏️ che appare al passaggio del mouse per rinominare taccuini, sezioni e pagine.</p><p>Imposta un colore e vedrai che verrà ereditato da tutto il contenuto.</p>`;
      saveStore();
    }
  } catch (e) { console.error("Failed to load store", e); Store = JSON.parse(JSON.stringify(defaultStore)); }
}
function saveStore() { try { localStorage.setItem(DB_KEY, JSON.stringify(Store)); } catch (e) { console.error("Failed to save store", e); } }

/* -------------------- DATA MANIPULATION & DELETION -------------------- */
function createNotebook(title, persist = true) {
  const id = createId('nb');
  const notebook = { id, title, sections: [], collapsed: false, color: null };
  Store.notebooks[id] = notebook;
  Store.notebookOrder.push(id);
  if (persist) saveStore();
  return notebook;
}
function createSection(notebookId, title, persist = true) {
  const id = createId('sec');
  const section = { id, notebookId, title, pages: [], color: null };
  Store.sections[id] = section;
  Store.notebooks[notebookId].sections.push(id);
  if (persist) saveStore();
  return section;
}
function createPage(sectionId, title, persist = true) {
  const id = createId('pg');
  const now = new Date().toISOString();
  const page = { id, sectionId, title, html: '<p></p>', createdAt: now, updatedAt: now, color: null };
  Store.pages[id] = page;
  Store.sections[sectionId].pages.push(id);
  if (persist) saveStore();
  return page;
}
function deletePage(pageId) {
    if (!confirm(`Sei sicuro di voler eliminare la pagina "${Store.pages[pageId]?.title || ''}"?`)) return;
    const page = Store.pages[pageId]; if (!page) return;
    const section = Store.sections[page.sectionId];
    if (section) { section.pages = section.pages.filter(id => id !== pageId); }
    delete Store.pages[pageId];
    if (AppState.activePageId === pageId) { AppState.activePageId = null; }
    saveStore(); refreshUI();
}
function deleteSection(sectionId, cascade = false) {
    if (!cascade && !confirm(`Sei sicuro di voler eliminare la sezione "${Store.sections[sectionId]?.title || ''}" e TUTTE le sue pagine?`)) return;
    const section = Store.sections[sectionId]; if (!section) return;
    section.pages.forEach(pageId => delete Store.pages[pageId]);
    const notebook = Store.notebooks[section.notebookId];
    if (notebook) { notebook.sections = notebook.sections.filter(id => id !== sectionId); }
    delete Store.sections[sectionId];
    if (AppState.activeSectionId === sectionId) { AppState.activeSectionId = null; AppState.activePageId = null; }
    if (!cascade) { saveStore(); refreshUI(); }
}
function deleteNotebook(notebookId) {
    if (!confirm(`Sei sicuro di voler eliminare il taccuino "${Store.notebooks[notebookId]?.title || ''}" e TUTTO il suo contenuto? L'azione è irreversibile.`)) return;
    const notebook = Store.notebooks[notebookId]; if (!notebook) return;
    notebook.sections.forEach(sectionId => deleteSection(sectionId, true));
    delete Store.notebooks[notebookId];
    Store.notebookOrder = Store.notebookOrder.filter(id => id !== notebookId);
    if (AppState.activeNotebookId === notebookId) {
        AppState.activeNotebookId = null;
        AppState.activeSectionId = null;
        AppState.activePageId = null;
    }
    saveStore(); refreshUI();
}

/* -------------------- COLOR LOGIC (WITH INHERITANCE) -------------------- */
function getEffectiveColor(type, id) {
    if (type === 'page') {
        const page = Store.pages[id]; if (!page) return null;
        if (page.color) return page.color;
        return getEffectiveColor('section', page.sectionId);
    }
    if (type === 'section') {
        const section = Store.sections[id]; if (!section) return null;
        if (section.color) return section.color;
        const notebook = Store.notebooks[section.notebookId];
        return notebook ? notebook.color : null;
    }
    return null;
}
let activePaletteContext = null;
function openColorPalette(context, triggerEl) {
  const palette = getEl('#color-palette');
  if (activePaletteContext && activePaletteContext.id === context.id) { closeColorPalette(); return; }
  activePaletteContext = context;
  palette.innerHTML = '';
  COLOR_PALETTE.forEach(color => {
    const swatch = document.createElement('div'); swatch.className = 'palette-swatch';
    swatch.style.backgroundColor = color; swatch.dataset.color = color;
    palette.appendChild(swatch);
  });
  const rect = triggerEl.getBoundingClientRect();
  palette.style.display = 'grid';
  palette.style.top = `${rect.bottom + 5}px`;
  palette.style.left = `${rect.left}px`;
}
function closeColorPalette() { getEl('#color-palette').style.display = 'none'; activePaletteContext = null; }

/* -------------------- UI RENDERING -------------------- */
function displayNotebooks() {
  const listEl = getEl('#notebooks-list');
  listEl.innerHTML = '';
  Store.notebookOrder.forEach(nbId => {
    const nb = Store.notebooks[nbId]; if (!nb) return;
    const item = document.createElement('div'); item.className = 'tree-item';
    if (nb.color) {
      item.style.backgroundColor = nb.color;
      item.style.color = getContrastColor(nb.color);
      if (AppState.activeNotebookId === nbId) item.style.boxShadow = 'inset 0 0 0 2px white';
    } else { if (AppState.activeNotebookId === nbId) item.classList.add('active'); }
    const colorDot = document.createElement('div'); colorDot.className = 'color-dot'; colorDot.style.backgroundColor = nb.color || 'transparent';
    colorDot.title = 'Colore taccuino';
    colorDot.onclick = (e) => { e.stopPropagation(); openColorPalette({ type: 'notebook', id: nb.id }, colorDot); };
    const icon = document.createElement('span'); icon.textContent = '📒';
    const titleInput = document.createElement('input'); titleInput.className = 'title-input grow'; titleInput.value = nb.title; titleInput.readOnly = true;
    const actions = document.createElement('div'); actions.className = 'actions-container';
    const editBtn = document.createElement('button'); editBtn.className = 'action-btn'; editBtn.innerHTML = '✏️';
    editBtn.title = "Rinomina taccuino";
    editBtn.onclick = (e) => { e.stopPropagation(); makeEditable(titleInput, (newTitle) => { nb.title = newTitle; saveStore(); refreshUI(); }); };
    const deleteBtn = document.createElement('button'); deleteBtn.className = 'action-btn delete-btn'; deleteBtn.innerHTML = '🗑️';
    deleteBtn.title = `Elimina il taccuino "${nb.title}"`;
    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteNotebook(nb.id); };
    actions.append(editBtn, deleteBtn);
    item.append(colorDot, icon, titleInput, actions);
    item.onclick = (e) => { 
        if(e.target.closest('.actions-container')) return;
        AppState.activeNotebookId = nb.id;
        nb.collapsed = !nb.collapsed;
        AppState.activeSectionId = null; AppState.activePageId = null;
        saveStore(); refreshUI();
    };
    listEl.appendChild(item);
    if (!nb.collapsed && AppState.activeNotebookId === nbId) { nb.sections.forEach(secId => displaySection(secId, listEl)); }
  });
}

function displaySection(secId, parentEl) {
  const sec = Store.sections[secId]; if (!sec) return;
  const item = document.createElement('div'); item.className = 'tree-item'; item.style.marginLeft = '20px';
  const effectiveColor = getEffectiveColor('section', secId);
  if (effectiveColor) {
    item.style.backgroundColor = effectiveColor;
    item.style.color = getContrastColor(effectiveColor);
    if (AppState.activeSectionId === secId) item.style.boxShadow = 'inset 0 0 0 2px white';
  } else { if (AppState.activeSectionId === secId) item.classList.add('active'); }
  const colorDot = document.createElement('div'); colorDot.className = 'color-dot'; colorDot.style.backgroundColor = sec.color || 'transparent';
  colorDot.title = 'Colore sezione';
  colorDot.onclick = (e) => { e.stopPropagation(); openColorPalette({ type: 'section', id: sec.id }, colorDot); };
  const icon = document.createElement('span'); icon.textContent = '📂';
  const titleInput = document.createElement('input'); titleInput.className = 'title-input grow'; titleInput.value = sec.title; titleInput.readOnly = true;
  const actions = document.createElement('div'); actions.className = 'actions-container';
  const editBtn = document.createElement('button'); editBtn.className = 'action-btn'; editBtn.innerHTML = '✏️';
  editBtn.title = "Rinomina sezione";
  editBtn.onclick = (e) => { e.stopPropagation(); makeEditable(titleInput, (newTitle) => { sec.title = newTitle; saveStore(); refreshUI(); }); };
  const deleteBtn = document.createElement('button'); deleteBtn.className = 'action-btn delete-btn'; deleteBtn.innerHTML = '🗑️';
  deleteBtn.title = `Elimina sezione`;
  deleteBtn.onclick = (e) => { e.stopPropagation(); deleteSection(sec.id); };
  actions.append(editBtn, deleteBtn);
  item.append(colorDot, icon, titleInput, actions);
  item.onclick = (e) => { if(!e.target.closest('.actions-container')) { AppState.activeSectionId = sec.id; AppState.activePageId = null; refreshUI(); }};
  parentEl.appendChild(item);
}

function displayPages() {
  const listEl = getEl('#pages-list'), headerEl = getEl('#pages-list-header');
  listEl.innerHTML = '';
  if (!AppState.activeSectionId) { headerEl.textContent = 'Pagine'; listEl.innerHTML = '<div style="padding: 15px; color: var(--text-muted);">Seleziona una sezione</div>'; return; }
  const section = Store.sections[AppState.activeSectionId]; if (!section) return;
  headerEl.textContent = section.title;
  section.pages.forEach(pageId => {
    const page = Store.pages[pageId]; if (!page) return;
    const item = document.createElement('div'); item.className = 'page-entry';
    const effectiveColor = getEffectiveColor('page', pageId);
    if (effectiveColor) {
      item.style.backgroundColor = effectiveColor;
      item.style.color = getContrastColor(effectiveColor);
      if (AppState.activePageId === pageId) item.style.boxShadow = 'inset 0 0 0 2px rgba(255,255,255,.75)';
    } else { if (AppState.activePageId === pageId) item.classList.add('active'); }
    const colorDot = document.createElement('div'); colorDot.className = 'color-dot'; colorDot.style.backgroundColor = page.color || 'transparent';
    colorDot.title = 'Colore pagina';
    colorDot.onclick = (e) => { e.stopPropagation(); openColorPalette({ type: 'page', id: page.id }, colorDot); };
    const icon = document.createElement('span'); icon.textContent = '📝';
    const titleInput = document.createElement('input'); titleInput.className = 'title-input grow'; titleInput.value = page.title; titleInput.readOnly = true;
    const actions = document.createElement('div'); actions.className = 'actions-container';
    const editBtn = document.createElement('button'); editBtn.className = 'action-btn'; editBtn.innerHTML = '✏️';
    editBtn.title = "Rinomina pagina";
    editBtn.onclick = (e) => { e.stopPropagation(); makeEditable(titleInput, (newTitle) => { page.title = newTitle; saveStore(); refreshUI(); }); };
    const deleteBtn = document.createElement('button'); deleteBtn.className = 'action-btn delete-btn'; deleteBtn.innerHTML = '🗑️';
    deleteBtn.title = `Elimina pagina`;
    deleteBtn.onclick = (e) => { e.stopPropagation(); deletePage(page.id); };
    actions.append(editBtn, deleteBtn);
    item.append(colorDot, icon, titleInput, actions);
    item.onclick = (e) => { if(!e.target.closest('.actions-container')) { AppState.activePageId = page.id; refreshUI(); }};
    listEl.appendChild(item);
  });
}

function displayActivePage() {
    const page = Store.pages[AppState.activePageId];
    const editorWrapper = getEl('#editor-view .view-content');
    const pageTitleContainer = getEl('#page-title-container');
    const pageTitleInput = getEl('#page-title-input');

    // Pulisci i vecchi listener per evitare duplicati
    const oldEditBtn = pageTitleContainer.querySelector('.action-btn');
    if(oldEditBtn) oldEditBtn.remove();

    if (!page) { 
        editorWrapper.classList.add('hidden');
        return; 
    }
    
    editorWrapper.classList.remove('hidden');
    pageTitleInput.value = page.title;
    getEl('#editor-area').innerHTML = page.html || '<p></p>';

    // Aggiungi il pulsante di modifica per il titolo principale
    const editBtn = document.createElement('button');
    editBtn.className = 'action-btn';
    editBtn.innerHTML = '✏️';
    editBtn.title = "Rinomina pagina";
    editBtn.onclick = (e) => { 
        e.stopPropagation(); 
        makeEditable(pageTitleInput, (newTitle) => {
            page.title = newTitle;
            page.updatedAt = new Date().toISOString();
            saveStore();
            refreshUI();
        });
    };
    pageTitleContainer.appendChild(editBtn);
}

function refreshUI() {
  displayNotebooks(); 
  displayPages(); 
  displayActivePage();
  getEl('#addSectionBtn').disabled = !AppState.activeNotebookId;
  getEl('#addPageBtn').disabled = !AppState.activeSectionId;
}

/* -------------------- EVENT HANDLERS & APP LOGIC -------------------- */
function setupEventListeners() {
  getEl('#addNotebookBtn').onclick = () => {
    const title = prompt("Inserisci il nome del nuovo taccuino:", "Nuovo Taccuino");
    if (title && title.trim()) {
      const nb = createNotebook(title.trim());
      AppState.activeNotebookId = nb.id; AppState.activeSectionId = null; AppState.activePageId = null;
      refreshUI();
    }
  };
  getEl('#addSectionBtn').onclick = () => { if(!AppState.activeNotebookId) return; const sec = createSection(AppState.activeNotebookId, 'Nuova Sezione'); AppState.activeSectionId = sec.id; refreshUI(); };
  getEl('#addPageBtn').onclick = () => { if(!AppState.activeSectionId) return; const page = createPage(AppState.activeSectionId, 'Nuova Pagina'); AppState.activePageId = page.id; refreshUI(); };
  
  let saveTimeout;
  const saveEditorContent = () => {
    if (!AppState.activePageId) return;
    const page = Store.pages[AppState.activePageId]; if (!page) return;
    page.html = getEl('#editor-area').innerHTML; page.updatedAt = new Date().toISOString();
    saveStore(); 
  };
  getEl('#editor-area').oninput = () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveEditorContent, 1000); };
  
  getEl('#color-palette').addEventListener('click', (e) => {
    const swatch = e.target.closest('.palette-swatch');
    if (swatch && activePaletteContext) {
      const color = swatch.dataset.color;
      let target;
      if (activePaletteContext.type === 'notebook') target = Store.notebooks[activePaletteContext.id];
      else if (activePaletteContext.type === 'section') target = Store.sections[activePaletteContext.id];
      else if (activePaletteContext.type === 'page') target = Store.pages[activePaletteContext.id];
      if (target) { target.color = (target.color === color) ? null : color; }
      saveStore(); refreshUI(); closeColorPalette();
    }
  });
  document.addEventListener('click', (e) => {
    if (!getEl('#color-palette').contains(e.target) && !e.target.closest('.color-dot')) { closeColorPalette(); }
  });
  getEl('#deletePageBtn').onclick = () => { if (AppState.activePageId) deletePage(AppState.activePageId); };
  getEl('#exportDataBtn').onclick = () => { downloadFile(`gpt-notes-data.json`, JSON.stringify(Store, null, 2), 'application/json'); };
  getEl('#importDataInput').onchange = (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const json = JSON.parse(event.target.result);
        if (!json.notebooks || !json.sections || !json.pages) throw new Error('File non valido');
        Store = json; AppState = { activeNotebookId: null, activeSectionId: null, activePageId: null };
        saveStore(); initApp(); alert('Dati importati con successo!');
      } catch (err) { alert('Errore: impossibile importare il file.'); }
    };
    reader.readAsText(file);
    e.target.value = '';
  };
}

function initApp() {
    loadStore();
    if (Store.notebookOrder.length > 0) {
      AppState.activeNotebookId = Store.notebookOrder[0];
      const nb = Store.notebooks[AppState.activeNotebookId];
      if (nb && nb.sections.length > 0) {
        AppState.activeSectionId = nb.sections[0];
        const sec = Store.sections[AppState.activeSectionId];
        if (sec && sec.pages.length > 0) { AppState.activePageId = sec.pages[0]; }
      }
    }
    refreshUI();
    getEl('#loader').style.display = 'none'; 
    getEl('#app-container').classList.add('loaded');
}

document.addEventListener('DOMContentLoaded', () => {
  setupEventListeners();
  initApp();
});
</script>
</body>
</html>
